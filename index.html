<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle Acadêmico Universitário - Direito</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2c3e50;      /* Dark Slate Blue */
      --secondary: #34495e;    /* Lighter Slate Blue */
      --accent: #1abc9c;        /* Teal */
      --light: #ecf0f1;         /* Light Gray */
      --dark: #2c3e50;          /* Using primary for text for cohesion */
      --success: #27ae60;       /* Emerald Green */
      --warning: #f1c40f;       /* Sunflower Yellow */
      --danger: #e74c3c;        /* Alizarin Red */
      --info: #3498db;          /* Peter River Blue */
      --orange: #e67e22;        /* Carrot Orange */
      --purple: #9b59b6;        /* Amethyst Purple */
      --light-accent: rgba(26, 188, 156, 0.1); /* Pale Teal */
      --text-dark: #34495e;      /* Using secondary for main text */
      --text-light: #7f8c8d;     /* Grayish text */
      --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease-in-out;
    }

    body {
      background-color: var(--light);
      font-family: 'Poppins', sans-serif;
      color: var(--text-dark);
      line-height: 1.6;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Playfair Display', serif;
      color: var(--primary);
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      color: white;
      padding: 20px 0;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: var(--transition);
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .sidebar-logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .sidebar-subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .nav-item {
      margin: 5px 15px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-link {
      color: white;
      padding: 12px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      transition: var(--transition);
    }

    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .nav-link i {
      width: 24px;
      margin-right: 12px;
      font-size: 1.1rem;
    }

    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      transition: var(--transition);
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #dce4e6;
    }

    .card-link {
      transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
      cursor: pointer;
      border-radius: 15px;
      box-shadow: var(--shadow);
      color: var(--dark);
      border: none;
      height: 100%;
      background: white;
    }

    .card-link:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .card-link:hover .icon-wrapper {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(26, 188, 156, 0.3);
    }

    .card-link .card-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 25px 20px;
      text-align: center;
    }

    .card-link .icon-wrapper {
      background-color: var(--accent);
      color: white;
      border-radius: 50%;
      margin-bottom: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 70px;
      height: 70px;
      font-size: 1.8rem;
      transition: var(--transition);
    }

    .card-link h5 {
      margin-bottom: 0;
      font-weight: 600;
      color: var(--primary);
    }
    
    /* ESTILOS PARA CARDS COLORIDOS */
    .card-link[style*="background-color"] {
        color: white;
    }

    .card-link[style*="background-color"]:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        filter: brightness(1.1);
    }
    
    .card-link[style*="background-color"]:hover .icon-wrapper {
        box-shadow: none;
    }

    .card-link[style*="background-color"] h5 {
        color: white;
    }

    .card-link[style*="background-color"] .icon-wrapper {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .content-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-dashboard {
      border-radius: 15px;
      border: none;
      box-shadow: var(--shadow);
      transition: var(--transition);
      background: white;
      height: 100%;
    }

    .card-dashboard:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .card-dashboard .card-body {
      padding: 1.5rem;
    }

    .progress {
      height: 10px;
      border-radius: 5px;
      background-color: #e9ecef;
    }

    .event-calendar {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .calendar-day {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .calendar-day:not(.empty):hover {
      background-color: #e9ecef;
    }

    .calendar-day.has-event {
      background-color: var(--light-accent);
      color: var(--primary);
      font-weight: bold;
    }

    .calendar-day.current {
      background-color: var(--accent);
      color: white;
    }

    .event-indicator {
      position: absolute;
      bottom: 2px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 2px;
    }

    .event-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }

    .event-dot.assignment {
      background-color: var(--info);
    }

    .event-dot.exam {
      background-color: var(--danger);
    }

    .event-dot.other {
      background-color: var(--warning);
    }

    .badge-priority {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      color: white;
    }

    .priority-high {
      background-color: var(--danger);
    }

    .priority-medium {
      background-color: var(--warning);
      color: var(--text-dark);
    }

    .priority-low {
      background-color: var(--success);
    }

    .avg-grade-badge {
      font-size: 1.25rem;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border-radius: 10px;
    }

    .btn-primary {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background-color: #16a085;
      border-color: #16a085;
    }

    .btn-outline-primary {
      color: var(--accent);
      border-color: var(--accent);
    }

    .btn-outline-primary:hover {
      background-color: var(--accent);
      color: white;
    }
    
    .table th {
      font-weight: 600;
      color: var(--primary);
      border-top: none;
    }

    .modal-content {
      border-radius: 12px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      background-color: var(--primary);
      color: white;
      border-radius: 12px 12px 0 0;
    }

    .modal-title {
      font-weight: 600;
    }

    .stats-card {
      display: flex;
      align-items: center;
    }

    .stats-card i {
      font-size: 2.5rem;
      opacity: 0.8;
      color: var(--accent);
    }

    .stats-info {
      margin-left: 15px;
    }

    .stats-info h4 {
      margin-bottom: 0;
      font-weight: 700;
    }

    .stats-info p {
      margin-bottom: 0;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .event-item {
      border-left: 4px solid var(--accent);
      padding: 10px 15px;
      margin-bottom: 10px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .event-item.assignment {
      border-left-color: var(--info);
    }

    .event-item.exam {
      border-left-color: var(--danger);
    }

    .event-item.other {
      border-left-color: var(--warning);
    }

    .event-item.completed {
      opacity: 0.7;
      border-left-color: var(--success);
    }

    .report-section {
      margin-bottom: 30px;
    }

    .report-header {
      background-color: var(--primary);
      color: white;
      padding: 10px 15px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
    }

    .report-body {
      padding: 15px;
      background-color: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .report-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .empty-state {
      padding: 20px;
      text-align: center;
      color: var(--text-light);
    }
    
    /* ESTILOS QUADRO DE HORÁRIOS */
    .schedule-grid-wrapper {
        overflow-x: auto;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    .schedule-grid {
        display: grid;
        grid-template-columns: 80px repeat(6, 1fr); /* Horas + 6 dias */
        grid-auto-rows: 50px;
        gap: 5px;
        min-width: 800px;
    }

    .schedule-header, .schedule-time-slot {
        background-color: var(--primary);
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 0.9rem;
        padding: 5px;
    }

    .schedule-time-slot {
        background-color: var(--light);
        color: var(--text-dark);
        font-size: 0.8rem;
    }

    .schedule-grid > div:first-child {
        background: transparent;
    }
    
    .schedule-class-item {
        position: relative;
        background-color: var(--secondary);
        color: white;
        border-radius: 8px;
        padding: 8px;
        font-size: 0.8rem;
        overflow: hidden;
        cursor: pointer;
        transition: var(--transition);
        border-left: 5px solid var(--primary);
    }
    .schedule-class-item:hover {
        opacity: 0.9;
        transform: scale(1.02);
    }
    .schedule-class-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    .schedule-class-details {
        font-size: 0.75rem;
        opacity: 0.9;
    }

    /* Responsividade */
    @media (max-width: 992px) {
      .app-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: fixed;
        bottom: 0;
        z-index: 1000;
        padding: 10px 0;
      }

      .sidebar-header {
        display: none;
      }

      .nav-menu {
        display: flex;
        overflow-x: auto;
        padding: 0 10px;
      }

      .nav-item {
        margin: 0 5px;
        flex-shrink: 0;
      }

      .nav-link {
        flex-direction: column;
        padding: 10px;
        font-size: 0.8rem;
      }

      .nav-link i {
        margin-right: 0;
        margin-bottom: 5px;
        font-size: 1.2rem;
      }

      .main-content {
        padding: 20px 15px 80px;
      }
    }

    @media (max-width: 768px) {
      .content-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .content-header .btn-group {
        margin-top: 15px;
        align-self: flex-end;
      }

      .card-link .card-body {
        padding: 20px 15px;
      }

      .card-link .icon-wrapper {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }

      .stats-card {
        flex-direction: column;
        text-align: center;
      }

      .stats-info {
        margin-left: 0;
        margin-top: 10px;
      }
    }

    .sidebar-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      border: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 992px) {
      .sidebar-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sidebar {
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .sidebar.open {
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">Acadêmico Pro</div>
      <div class="sidebar-subtitle">Controle Estudantil</div>
    </div>
    <nav>
      <div class="nav-menu">
        <div class="nav-item">
          <a class="nav-link active" href="#" data-target="home-links">
            <i class="fas fa-home"></i>
            <span>Início</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="dashboard">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="disciplinas">
            <i class="fas fa-book"></i>
            <span>Disciplinas</span>
          </a>
        </div>
        <div class="nav-item">
            <a class="nav-link" href="#" data-target="horarios">
                <i class="fas fa-table-cells"></i>
                <span>Horários</span>
            </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="trabalhos">
            <i class="fas fa-tasks"></i>
            <span>Trabalhos</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="provas">
            <i class="fas fa-file-alt"></i>
            <span>Provas</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="agenda">
            <i class="fas fa-calendar-alt"></i>
            <span>Agenda</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="financeiro">
            <i class="fas fa-dollar-sign"></i>
            <span>Financeiro</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-target="relatorios">
            <i class="fas fa-chart-pie"></i>
            <span>Relatórios</span>
          </a>
        </div>
         <div class="nav-item">
          <a class="nav-link" href="#" data-target="configuracoes">
            <i class="fas fa-cog"></i>
            <span>Configurações</span>
          </a>
        </div>
      </div>
    </nav>
  </aside>

  <main class="main-content">
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-bars"></i>
    </button>

    <div class="content-panel active" id="home-links">
      <div class="content-header">
        <h2>Início Rápido</h2>
      </div>
      <div class="row g-4">
        </div>
    </div>

    <div class="content-panel" id="dashboard">
        <div class="content-header">
            <h2>Dashboard</h2>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="stats-card">
                            <i class="fas fa-book"></i>
                            <div class="stats-info">
                                <h4 id="dashboard-disciplinas-count">0</h4>
                                <p>Disciplinas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="stats-card">
                            <i class="fas fa-tasks text-info"></i>
                            <div class="stats-info">
                                <h4 id="dashboard-trabalhos-pendentes">0</h4>
                                <p>Trabalhos Pendentes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="stats-card">
                            <i class="fas fa-file-alt text-warning"></i>
                            <div class="stats-info">
                                <h4 id="dashboard-provas-agendadas">0</h4>
                                <p>Provas Agendadas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="stats-card">
                            <i class="fas fa-chart-line text-success"></i>
                            <div class="stats-info">
                                <h4 id="dashboard-media-geral">0.0</h4>
                                <p>Média Geral</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Desempenho por Disciplina</h4>
                        <div id="dashboard-desempenho-disciplinas">
                            <div class="empty-state">
                                <p>Nenhuma disciplina cadastrada.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Próximos Eventos</h4>
                        <div id="dashboard-proximos-eventos">
                            <div class="empty-state">
                                <p>Nenhum evento próximo.</p>
                            </div>
                        </div>
                        <a href="#" class="btn btn-outline-primary btn-sm mt-3" data-target="agenda">Ver Agenda Completa</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-panel" id="disciplinas">
      <div class="content-header">
        <h2>Disciplinas</h2>
        <div class="btn-group">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#disciplinaModal">
            <i class="fas fa-plus"></i> Nova Disciplina
          </button>
        </div>
      </div>
      <div class="row g-4" id="disciplinas-lista">
        </div>
    </div>

    <div class="content-panel" id="horarios">
        <div class="content-header">
            <h2>Quadro de Horários</h2>
            <div class="btn-group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#horarioModal">
                    <i class="fas fa-plus"></i> Nova Aula
                </button>
            </div>
        </div>
        <div class="schedule-grid-wrapper">
            <div class="schedule-grid" id="schedule-grid-container">
                </div>
        </div>
    </div>

    <div class="content-panel" id="trabalhos">
      <div class="content-header">
        <h2>Trabalhos</h2>
        <div class="btn-group">
           <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#trabalhoModal">
            <i class="fas fa-plus"></i> Novo Trabalho
          </button>
        </div>
      </div>
      <div class="card card-dashboard">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Disciplina</th>
                  <th>Título</th>
                  <th>Entrega</th>
                  <th>Status</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="trabalhos-tabela"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="content-panel" id="provas">
        <div class="content-header">
            <h2>Provas</h2>
            <div class="btn-group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#provaModal">
                    <i class="fas fa-plus"></i> Nova Prova
                </button>
            </div>
        </div>
        <div class="card card-dashboard">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Disciplina</th>
                                <th>Conteúdo</th>
                                <th>Data</th>
                                <th>Hora</th>
                                <th>Status</th>
                                <th>Nota</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="provas-tabela"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="content-panel" id="agenda">
        <div class="content-header">
            <h2>Agenda</h2>
            <div class="btn-group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal" id="novoEventoBtn">
                    <i class="fas fa-plus"></i> Novo Evento
                </button>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="event-calendar">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <button class="btn btn-sm btn-outline-primary" id="prev-month">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <h5 class="mb-0" id="calendar-month-year"></h5>
                                <button class="btn btn-sm btn-outline-primary" id="next-month">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="row mb-2" id="calendar-weekdays"></div>
                            <div id="calendar-days"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-dashboard">
                    <div class="card-body" id="agenda-eventos-dia">
                        <h4 class="card-title mb-4">Eventos do Dia</h4>
                        <p class="text-muted text-center">Selecione um dia no calendário</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-panel" id="financeiro">
        <div class="content-header">
            <h2>Controle Financeiro</h2>
            <div class="btn-group">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#financeiroModal" data-type="receita">
                    <i class="fas fa-plus"></i> Nova Receita
                </button>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#financeiroModal" data-type="despesa">
                    <i class="fas fa-minus"></i> Nova Despesa
                </button>
            </div>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Receitas</h6>
                        <h3 class="text-success" id="financeiro-total-receitas">R$ 0,00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Despesas</h6>
                        <h3 class="text-danger" id="financeiro-total-despesas">R$ 0,00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Saldo Atual</h6>
                        <h3 id="financeiro-saldo-atual">R$ 0,00</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="card card-dashboard">
            <div class="card-body">
                <h4 class="card-title mb-3">Histórico de Transações</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th class="text-end">Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="financeiro-tabela"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="content-panel" id="relatorios">
        <div class="content-header">
            <h2>Relatórios</h2>
        </div>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="report-section">
                    <h4 class="report-header">Desempenho por Disciplina</h4>
                    <div class="report-body" id="relatorio-desempenho"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="report-section">
                    <h4 class="report-header">Frequência</h4>
                    <div class="report-body" id="relatorio-frequencia"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="report-section">
                    <h4 class="report-header">Trabalhos Entregues</h4>
                    <div class="report-body" id="relatorio-trabalhos"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="report-section">
                    <h4 class="report-header">Provas Realizadas</h4>
                    <div class="report-body" id="relatorio-provas"></div>
                </div>
            </div>
        </div>
    </div>
      
    <div class="content-panel" id="configuracoes">
        <div class="content-header">
            <h2>Configurações</h2>
        </div>
        <div class="card card-dashboard">
            <div class="card-body">
                <h4 class="card-title">Backup e Restauração de Dados</h4>
                <p class="text-muted">Salve seus dados em um arquivo para segurança ou para transferir para outro dispositivo.</p>
                <div class="mt-4">
                    <button class="btn btn-primary" id="backup-btn">
                        <i class="fas fa-download"></i> Criar Backup (Exportar)
                    </button>
                    <label for="restore-input" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-upload"></i> Restaurar Backup (Importar)
                    </label>
                    <input type="file" id="restore-input" class="d-none" accept=".json">
                </div>
                <div class="alert alert-warning mt-4">
                    <strong>Atenção:</strong> Restaurar um backup substituirá todos os dados atuais. Esta ação não pode ser desfeita.
                </div>
            </div>
        </div>
    </div>

  </main>
</div>

<div class="modal fade" id="horarioModal" tabindex="-1" aria-labelledby="horarioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="horarioModalLabel">Nova Aula</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="horarioForm">
                    <input type="hidden" id="horarioId">
                    <div class="mb-3">
                        <label for="horarioDisciplina" class="form-label">Disciplina</label>
                        <select class="form-select" id="horarioDisciplina" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="horarioDiaSemana" class="form-label">Dia da Semana</label>
                        <select class="form-select" id="horarioDiaSemana" required>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="horarioInicio" class="form-label">Hora de Início</label>
                            <input type="time" class="form-control" id="horarioInicio" step="1800" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="horarioFim" class="form-label">Hora de Fim</label>
                            <input type="time" class="form-control" id="horarioFim" step="1800" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="horarioLocal" class="form-label">Local / Sala</label>
                        <input type="text" class="form-control" id="horarioLocal">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-danger me-auto d-none" id="deleteHorario">Excluir</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveHorario">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="disciplinaModal" tabindex="-1" aria-labelledby="disciplinaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="disciplinaModalLabel">Nova Disciplina</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="disciplinaForm">
                    <input type="hidden" id="disciplinaId">
                    <div class="mb-3">
                        <label for="disciplinaNome" class="form-label">Nome da Disciplina</label>
                        <input type="text" class="form-control" id="disciplinaNome" required>
                    </div>
                    <div class="mb-3">
                        <label for="disciplinaProfessor" class="form-label">Professor(a)</label>
                        <input type="text" class="form-control" id="disciplinaProfessor">
                    </div>
                     <div class="mb-3">
                        <label for="disciplinaFrequencia" class="form-label">Frequência (%)</label>
                        <input type="number" class="form-control" id="disciplinaFrequencia" min="0" max="100" value="100">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveDisciplina">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="trabalhoModal" tabindex="-1" aria-labelledby="trabalhoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trabalhoModalLabel">Novo Trabalho</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="trabalhoForm">
                    <input type="hidden" id="trabalhoId">
                    <div class="mb-3">
                        <label for="trabalhoDisciplina" class="form-label">Disciplina</label>
                        <select class="form-select" id="trabalhoDisciplina" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="trabalhoTitulo" class="form-label">Título</label>
                        <input type="text" class="form-control" id="trabalhoTitulo" required>
                    </div>
                    <div class="mb-3">
                        <label for="trabalhoEntrega" class="form-label">Data de Entrega</label>
                        <input type="date" class="form-control" id="trabalhoEntrega" required>
                    </div>
                    <div class="mb-3">
                        <label for="trabalhoStatus" class="form-label">Status</label>
                        <select class="form-select" id="trabalhoStatus">
                            <option value="Pendente">Pendente</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trabalhoPrioridade" class="form-label">Prioridade</label>
                         <select class="form-select" id="trabalhoPrioridade">
                            <option value="low">Baixa</option>
                            <option value="medium" selected>Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                     <div class="mb-3">
                        <label for="trabalhoNota" class="form-label">Nota (0 a 10)</label>
                        <input type="number" step="0.1" class="form-control" id="trabalhoNota" min="0" max="10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveTrabalho">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="provaModal" tabindex="-1" aria-labelledby="provaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="provaModalLabel">Nova Prova</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="provaForm">
                    <input type="hidden" id="provaId">
                    <div class="mb-3">
                        <label for="provaDisciplina" class="form-label">Disciplina</label>
                        <select class="form-select" id="provaDisciplina" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="provaConteudo" class="form-label">Conteúdo</label>
                        <input type="text" class="form-control" id="provaConteudo" required>
                    </div>
                    <div class="mb-3">
                        <label for="provaData" class="form-label">Data</label>
                        <input type="date" class="form-control" id="provaData" required>
                    </div>
                    <div class="mb-3">
                        <label for="provaHora" class="form-label">Hora</label>
                        <input type="time" class="form-control" id="provaHora">
                    </div>
                    <div class="mb-3">
                        <label for="provaStatus" class="form-label">Status</label>
                        <select class="form-select" id="provaStatus">
                            <option value="Agendada">Agendada</option>
                            <option value="Realizada">Realizada</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="provaNota" class="form-label">Nota (0 a 10)</label>
                        <input type="number" step="0.1" class="form-control" id="provaNota" min="0" max="10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveProva">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">Novo Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
            <input type="hidden" id="eventId">
            <input type="hidden" id="eventRecurringId">
            <div class="mb-3">
                <label for="eventTitle" class="form-label">Título do Evento</label>
                <input type="text" class="form-control" id="eventTitle" required>
            </div>
            <div class="mb-3">
                <label for="eventType" class="form-label">Tipo de Evento</label>
                <select class="form-select" id="eventType" required>
                <option value="other" selected>Outro</option>
                <option value="assignment">Trabalho</option>
                <option value="exam">Prova</option>
                <option value="class">Aula</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="eventDate" class="form-label">Data</label>
                <input type="date" class="form-control" id="eventDate" required>
            </div>
            <div class="mb-3">
                <label for="eventTime" class="form-label">Hora (opcional)</label>
                <input type="time" class="form-control" id="eventTime">
            </div>
            <div class="mb-3">
                <label for="eventDescription" class="form-label">Descrição</label>
                <textarea class="form-control" id="eventDescription" rows="2"></textarea>
            </div>
            <hr>
            <div class="mb-3">
                <label for="eventRecurrence" class="form-label">Recorrência</label>
                <select class="form-select" id="eventRecurrence">
                    <option value="none" selected>Não repetir</option>
                    <option value="daily">Diariamente</option>
                    <option value="weekly">Semanalmente</option>
                    <option value="monthly">Mensalmente</option>
                </select>
            </div>
            <div class="mb-3 d-none" id="eventRecurrenceEndDateWrapper">
                <label for="eventRecurrenceEndDate" class="form-label">Repetir até</label>
                <input type="date" class="form-control" id="eventRecurrenceEndDate">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto d-none" id="deleteEvent">Excluir</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveEvent">Salvar Evento</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="financeiroModal" tabindex="-1" aria-labelledby="financeiroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="financeiroModalLabel">Nova Transação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="financeiroForm">
                    <input type="hidden" id="financeiroId">
                    <div class="mb-3">
                        <label for="financeiroTipo" class="form-label">Tipo</label>
                        <select class="form-select" id="financeiroTipo" required>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="financeiroDescricao" class="form-label">Descrição</label>
                        <input type="text" class="form-control" id="financeiroDescricao" required>
                    </div>
                    <div class="mb-3">
                        <label for="financeiroValor" class="form-label">Valor (R$)</label>
                        <input type="number" step="0.01" class="form-control" id="financeiroValor" required>
                    </div>
                    <div class="mb-3">
                        <label for="financeiroCategoria" class="form-label">Categoria</label>
                        <input type="text" class="form-control" id="financeiroCategoria">
                    </div>
                    <div class="mb-3">
                        <label for="financeiroData" class="form-label">Data</label>
                        <input type="date" class="form-control" id="financeiroData" required>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="financeiroRecurrence" class="form-label">Recorrência</label>
                        <select class="form-select" id="financeiroRecurrence">
                            <option value="none" selected>Não repetir</option>
                            <option value="weekly">Semanalmente</option>
                            <option value="monthly">Mensalmente</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="financeiroRecurrenceEndDateWrapper">
                        <label for="financeiroRecurrenceEndDate" class="form-label">Repetir até</label>
                        <input type="date" class="form-control" id="financeiroRecurrenceEndDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto d-none" id="deleteFinanceiro">Excluir</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveFinanceiro">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recurringActionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recurringActionModalTitle">Ação em Item Recorrente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Você está modificando um item que se repete. Como você gostaria de aplicar esta alteração?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-outline-primary" id="actionThisEvent">Apenas este</button>
        <button type="button" class="btn btn-primary" id="actionAllEvents">Toda a série</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// SCRIPT COMPLETO DA APLICAÇÃO
document.addEventListener('DOMContentLoaded', function() {
    
    //-----------------------------------------------------
    // 1. INICIALIZAÇÃO E GERENCIAMENTO DE DADOS (localStorage)
    //-----------------------------------------------------
    let db;
    let currentCalendarDate = new Date();

    const initialData = {
        disciplinas: [
            { id: 1, nome: "Direito Civil", professor: "Prof. Dr. Carlos Albuquerque", frequencia: 85 },
            { id: 2, nome: "Direito Constitucional", professor: "Prof. Dra. Maria Santos", frequencia: 92 },
            { id: 3, nome: "Direito Penal", professor: "Prof. Dr. Roberto Ferreira", frequencia: 88 },
            { id: 4, nome: "Direito Trabalhista", professor: "Prof. Dra. Ana Costa", frequencia: 75 }
        ],
        horarios: [
            { id: 1, disciplinaId: 1, diaSemana: 1, inicio: "08:00", fim: "10:00", local: "Sala 101" },
            { id: 2, disciplinaId: 3, diaSemana: 1, inicio: "10:00", fim: "12:00", local: "Sala 102" },
            { id: 3, disciplinaId: 2, diaSemana: 3, inicio: "08:00", fim: "12:00", local: "Auditório" },
            { id: 4, disciplinaId: 4, diaSemana: 5, inicio: "14:00", fim: "16:00", local: "Sala 205" }
        ],
        trabalhos: [
            { id: 1, disciplinaId: 1, titulo: "Estudo de Caso - Contratos", entrega: "2025-09-25", status: "Pendente", prioridade: "high", nota: null },
            { id: 2, disciplinaId: 3, titulo: "Artigo - Teoria do Crime", entrega: "2025-10-10", status: "Pendente", prioridade: "medium", nota: null }
        ],
        provas: [
            { id: 1, disciplinaId: 3, conteudo: "Teoria Geral do Crime", data: "2025-10-15", hora: "14:00", status: "Agendada", nota: null },
            { id: 2, disciplinaId: 1, conteudo: "Obrigações", data: "2025-10-20", hora: "10:00", status: "Agendada", nota: null }
        ],
        eventos: [
            { id: 1, title: "Seminário Internacional", type: 'other', date: "2025-09-30", time: "09:00", description: "Auditório Central" }
        ],
        financeiro: [
            { id: 1, tipo: "receita", descricao: "Bolsa Auxílio", valor: 500.00, categoria: "Bolsa", data: "2025-09-05" },
            { id: 2, tipo: "despesa", descricao: "Livro Vade Mecum", valor: 189.90, categoria: "Material de Estudo", data: "2025-09-10" }
        ]
    };

    function init() {
        const storedData = localStorage.getItem('lexAcademicaDB');
        if (storedData) {
            db = JSON.parse(storedData);
        } else {
            db = initialData;
        }
        // Garante que novas estruturas de dados sejam adicionadas se não existirem no DB salvo
        if (!db.horarios) db.horarios = [];
        if (!db.financeiro) db.financeiro = [];


        saveDB();
        generateQuickLinks();
        renderAll();
    }

    function saveDB() {
        localStorage.setItem('lexAcademicaDB', JSON.stringify(db));
    }

    //-----------------------------------------------------
    // 2. FUNÇÕES DE RENDERIZAÇÃO GERAL
    //-----------------------------------------------------
    function renderAll() {
        renderDashboard();
        renderDisciplinas();
        renderHorarios();
        renderTrabalhos();
        renderProvas();
        renderAgenda();
        renderFinanceiro();
        renderRelatorios();
        populateDisciplinaSelects();
    }

    function getDisciplinaById(id) {
        return db.disciplinas.find(d => d.id === parseInt(id));
    }

    function getNewId(dbKey) {
        return db[dbKey].length > 0 ? Math.max(...db[dbKey].map(item => item.id)) + 1 : 1;
    }

    const disciplinaColors = {};
    const colorPalette = ["#1abc9c", "#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#e74c3c", "#34495e", "#7f8c8d"];

    function getDisciplinaColor(disciplinaId) {
        if (!disciplinaColors[disciplinaId]) {
            disciplinaColors[disciplinaId] = colorPalette[Object.keys(disciplinaColors).length % colorPalette.length];
        }
        return disciplinaColors[disciplinaId];
    }
    
    //-----------------------------------------------------
    // 3. RENDERIZAÇÃO DOS PAINÉIS
    //-----------------------------------------------------

    function generateQuickLinks() {
        const container = document.getElementById('home-links').querySelector('.row');
        container.innerHTML = '';

        // Mapa de cores intuitivas para cada card
        const cardColors = {
            dashboard: 'var(--info)',
            disciplinas: 'var(--primary)',
            horarios: 'var(--purple)',
            trabalhos: 'var(--accent)',
            provas: 'var(--warning)',
            agenda: 'var(--orange)',
            financeiro: 'var(--success)',
            relatorios: 'var(--secondary)'
        };

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            const target = link.dataset.target;
            if (target === 'home-links' || target === 'configuracoes') return;
            const iconClass = link.querySelector('i').className;
            const title = link.querySelector('span').textContent;
            const cardColor = cardColors[target];
            const styleAttribute = cardColor ? `style="background-color: ${cardColor};"` : '';

            container.innerHTML += `
                <div class="col-md-6 col-lg-3 mb-4">
                  <div class="card card-link" data-target="${target}" ${styleAttribute}>
                    <div class="card-body">
                      <div class="icon-wrapper">
                        <i class="${iconClass}"></i>
                      </div>
                      <h5>${title}</h5>
                    </div>
                  </div>
                </div>
            `;
        });
    }

    function renderDashboard() {
        // Cards de estatísticas
        const trabalhosPendentes = db.trabalhos.filter(t => t.status === 'Pendente').length;
        const provasAgendadas = db.provas.filter(p => p.status === 'Agendada').length;

        document.getElementById('dashboard-disciplinas-count').textContent = db.disciplinas.length;
        document.getElementById('dashboard-trabalhos-pendentes').textContent = trabalhosPendentes;
        document.getElementById('dashboard-provas-agendadas').textContent = provasAgendadas;
        
        // Média Geral
        let todasNotas = [];
        db.trabalhos.forEach(t => { if(t.nota !== null) todasNotas.push(parseFloat(t.nota))});
        db.provas.forEach(p => { if(p.nota !== null) todasNotas.push(parseFloat(p.nota))});
        const mediaGeral = todasNotas.length > 0 ? (todasNotas.reduce((a, b) => a + b, 0) / todasNotas.length).toFixed(1) : "0.0";
        document.getElementById('dashboard-media-geral').textContent = mediaGeral;

        // Desempenho por disciplina
        const desempenhoContainer = document.getElementById('dashboard-desempenho-disciplinas');
        desempenhoContainer.innerHTML = '';
        if (db.disciplinas.length === 0) {
            desempenhoContainer.innerHTML = `<div class="empty-state"><p>Nenhuma disciplina cadastrada.</p></div>`;
        } else {
            db.disciplinas.forEach(d => {
                const notasTrabalhos = db.trabalhos.filter(t => t.disciplinaId === d.id && t.nota !== null).map(t => parseFloat(t.nota));
                const notasProvas = db.provas.filter(p => p.disciplinaId === d.id && p.nota !== null).map(p => parseFloat(p.nota));
                const notasDisciplina = [...notasTrabalhos, ...notasProvas];
                const mediaDisciplina = notasDisciplina.length > 0 ? (notasDisciplina.reduce((a, b) => a + b, 0) / notasDisciplina.length).toFixed(1) : "N/A";
                const progressWidth = mediaDisciplina !== "N/A" ? (mediaDisciplina / 10 * 100) : 0;
                
                const barColor = progressWidth >= 70 ? 'bg-success' : progressWidth >= 50 ? 'bg-warning' : 'bg-danger';

                desempenhoContainer.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center">
                       <p class="small mb-1">${d.nome}</p>
                       <p class="small mb-1">Média: ${mediaDisciplina}</p>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar ${barColor}" role="progressbar" style="width: ${progressWidth}%" aria-valuenow="${progressWidth}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                `;
            });
        }
        
        // Próximos eventos
        const eventosContainer = document.getElementById('dashboard-proximos-eventos');
        eventosContainer.innerHTML = '';
        const hoje = new Date();
        hoje.setHours(0,0,0,0);

        const todosEventos = [
            ...db.trabalhos.filter(t => t.status === 'Pendente').map(t => ({...t, type: 'assignment', date: t.entrega, title: t.titulo})),
            ...db.provas.filter(p => p.status === 'Agendada').map(p => ({...p, type: 'exam', date: p.data, title: p.conteudo})),
            ...db.eventos.map(e => ({...e}))
        ];
        
        const proximosEventos = todosEventos
            .filter(e => new Date(e.date + 'T00:00:00') >= hoje)
            .sort((a,b) => new Date(a.date) - new Date(b.date))
            .slice(0, 4);
        
        if (proximosEventos.length === 0) {
            eventosContainer.innerHTML = `<div class="empty-state"><p>Nenhum evento próximo.</p></div>`;
        } else {
            proximosEventos.forEach(evento => {
                let badge = '';
                if(evento.prioridade) {
                    const priorityClass = evento.prioridade === 'high' ? 'priority-high' : evento.prioridade === 'medium' ? 'priority-medium' : 'priority-low';
                    const priorityText = evento.prioridade === 'high' ? 'Alta' : evento.prioridade === 'medium' ? 'Média' : 'Baixa';
                    badge = `<span class="badge ${priorityClass}">${priorityText}</span>`;
                }
                eventosContainer.innerHTML += `
                    <div class="event-item ${evento.type}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 small">${evento.title}</h6>
                            ${badge}
                        </div>
                        <p class="mb-0 small text-muted">Data: ${new Date(evento.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    </div>
                `;
            });
        }
    }

    function renderDisciplinas() {
        const container = document.getElementById('disciplinas-lista');
        container.innerHTML = '';
        if (db.disciplinas.length === 0) {
            container.innerHTML = `<div class="col-12"><div class="empty-state card-dashboard p-4"><p>Clique em "Nova Disciplina" para começar.</p></div></div>`;
            return;
        }
        db.disciplinas.forEach(d => {
            const notasTrabalhos = db.trabalhos.filter(t => t.disciplinaId === d.id && t.nota !== null).map(t => parseFloat(t.nota));
            const notasProvas = db.provas.filter(p => p.disciplinaId === d.id && p.nota !== null).map(p => parseFloat(p.nota));
            const notasDisciplina = [...notasTrabalhos, ...notasProvas];
            const mediaDisciplina = notasDisciplina.length > 0 ? (notasDisciplina.reduce((a, b) => a + b, 0) / notasDisciplina.length).toFixed(1) : "N/A";
            const progressWidth = mediaDisciplina !== "N/A" ? (mediaDisciplina / 10 * 100) : 0;
            const barColor = progressWidth >= 70 ? 'bg-success' : progressWidth >= 50 ? 'bg-warning' : 'bg-danger';

            const card = `
                <div class="col-md-6 col-lg-4">
                  <div class="card card-dashboard">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                          <h4 class="card-title mb-0">${d.nome}</h4>
                           <p class="text-muted small">${d.professor}</p>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item edit-disciplina" href="#" data-id="${d.id}">Editar</a></li>
                            <li><a class="dropdown-item delete-disciplina" href="#" data-id="${d.id}">Excluir</a></li>
                          </ul>
                        </div>
                      </div>
                       <div class="d-flex justify-content-between small text-muted mb-2">
                        <span>Média</span>
                        <span class="avg-grade-badge ${barColor} text-white">${mediaDisciplina}</span>
                      </div>
                      <div class="progress mb-3">
                        <div class="progress-bar ${barColor}" role="progressbar" style="width: ${progressWidth}%"></div>
                      </div>
                      
                      <div class="d-flex justify-content-between small text-muted mb-2">
                        <span>Frequência</span>
                        <span>${d.frequencia}%</span>
                      </div>
                      <div class="progress mb-3">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: ${d.frequencia}%"></div>
                      </div>
                      
                      <div class="d-flex justify-content-between">
                        <span class="badge bg-info">${db.trabalhos.filter(t => t.disciplinaId === d.id).length} Trabalhos</span>
                        <span class="badge bg-warning">${db.provas.filter(p => p.disciplinaId === d.id).length} Provas</span>
                      </div>
                    </div>
                  </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function renderHorarios() {
        const container = document.getElementById('schedule-grid-container');
        container.innerHTML = '';
        
        // Define range de horas
        const horaInicio = 7;
        const horaFim = 22;
        const totalRows = (horaFim - horaInicio) * 2 + 1; // 30 min slots
        container.style.gridTemplateRows = `50px repeat(${totalRows -1}, 40px)`;
        
        // Cabeçalho
        container.innerHTML += `<div></div>`; // Canto vazio
        const dias = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        dias.forEach(dia => container.innerHTML += `<div class="schedule-header">${dia}</div>`);

        // Coluna de horas
        for (let i = horaInicio; i <= horaFim; i++) {
             container.innerHTML += `<div class="schedule-time-slot" style="grid-row: ${ (i - horaInicio) * 2 + 2 } / span 2">${String(i).padStart(2,'0')}:00</div>`;
        }

        // Aulas
        if (db.horarios.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.textContent = 'Nenhuma aula cadastrada.';
            emptyState.style.gridColumn = '2 / span 6';
            emptyState.style.gridRow = '2 / span 4';
            container.appendChild(emptyState);
        } else {
            db.horarios.forEach(aula => {
                const disciplina = getDisciplinaById(aula.disciplinaId);
                if (!disciplina) return;
                
                const inicioParts = aula.inicio.split(':');
                const fimParts = aula.fim.split(':');
                
                const startRow = (parseInt(inicioParts[0]) - horaInicio) * 2 + (parseInt(inicioParts[1]) / 30) + 2;
                const endRow = (parseInt(fimParts[0]) - horaInicio) * 2 + (parseInt(fimParts[1]) / 30) + 2;
                
                const col = parseInt(aula.diaSemana) + 1;

                const color = getDisciplinaColor(aula.disciplinaId);

                const item = document.createElement('div');
                item.className = 'schedule-class-item';
                item.dataset.id = aula.id;
                item.style.gridColumn = col;
                item.style.gridRow = `${startRow} / ${endRow}`;
                item.style.backgroundColor = color;
                item.style.borderColor = color;

                item.innerHTML = `
                    <div class="schedule-class-title">${disciplina.nome}</div>
                    <div class="schedule-class-details">
                        <i class="fas fa-map-marker-alt"></i> ${aula.local || ''}<br>
                        <i class="fas fa-clock"></i> ${aula.inicio} - ${aula.fim}
                    </div>
                `;
                container.appendChild(item);
            });
        }
    }
    
    function renderTrabalhos() {
        const tbody = document.getElementById('trabalhos-tabela');
        tbody.innerHTML = '';
        if (db.trabalhos.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Nenhum trabalho cadastrado.</td></tr>`;
            return;
        }
        db.trabalhos.sort((a, b) => new Date(a.entrega) - new Date(b.entrega)).forEach(t => {
            const disciplina = getDisciplinaById(t.disciplinaId);
            const statusClass = t.status === 'Pendente' ? 'bg-warning text-dark' : 'bg-success';
            const priorityClass = t.prioridade === 'high' ? 'priority-high' : t.prioridade === 'medium' ? 'priority-medium' : 'priority-low';
            const priorityText = t.prioridade === 'high' ? 'Alta' : t.prioridade === 'medium' ? 'Média' : 'Baixa';

            const row = `
                <tr>
                  <td>${disciplina ? disciplina.nome : 'N/A'}</td>
                  <td>${t.titulo}</td>
                  <td>${new Date(t.entrega + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge ${statusClass}">${t.status}</span></td>
                  <td><span class="badge ${priorityClass}">${priorityText}</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary edit-trabalho" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-trabalho" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                  </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function renderProvas() {
        const tbody = document.getElementById('provas-tabela');
        tbody.innerHTML = '';
        if (db.provas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">Nenhuma prova cadastrada.</td></tr>`;
            return;
        }
        db.provas.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(p => {
            const disciplina = getDisciplinaById(p.disciplinaId);
            const statusClass = p.status === 'Agendada' ? 'bg-warning text-dark' : 'bg-success';
            const row = `
                <tr>
                    <td>${disciplina ? disciplina.nome : 'N/A'}</td>
                    <td>${p.conteudo}</td>
                    <td>${new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${p.hora || 'N/A'}</td>
                    <td><span class="badge ${statusClass}">${p.status}</span></td>
                    <td>${p.nota !== null ? p.nota.toFixed(1) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-prova" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-prova" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    function renderAgenda() {
        const month = currentCalendarDate.getMonth();
        const year = currentCalendarDate.getFullYear();
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

        const weekdaysContainer = document.getElementById('calendar-weekdays');
        const daysContainer = document.getElementById('calendar-days');
        weekdaysContainer.innerHTML = '';
        daysContainer.innerHTML = '';

        const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        weekdays.forEach(day => {
            weekdaysContainer.innerHTML += `<div class="col text-center small"><strong>${day}</strong></div>`;
        });
        
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let currentRow = document.createElement('div');
        currentRow.className = 'row mb-2';

        for (let i = 0; i < firstDayOfMonth; i++) {
            currentRow.innerHTML += `<div class="col calendar-day empty"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = getEventsForDate(dateStr);
            let dayClasses = 'col calendar-day';
            let eventIndicator = '';

            if (dayEvents.length > 0) {
                dayClasses += ' has-event';
                eventIndicator += '<div class="event-indicator">';
                if (dayEvents.some(e => e.type === 'assignment')) eventIndicator += '<span class="event-dot assignment"></span>';
                if (dayEvents.some(e => e.type === 'exam')) eventIndicator += '<span class="event-dot exam"></span>';
                if (dayEvents.some(e => e.type === 'other' || e.type === 'class')) eventIndicator += '<span class="event-dot other"></span>';
                eventIndicator += '</div>';
            }
            
            currentRow.innerHTML += `<div class="${dayClasses}" data-date="${dateStr}">${day}${eventIndicator}</div>`;

            if ((day + firstDayOfMonth) % 7 === 0 || day === daysInMonth) {
                daysContainer.appendChild(currentRow);
                currentRow = document.createElement('div');
                currentRow.className = 'row mb-2';
            }
        }
    }

    function renderFinanceiro() {
        const tbody = document.getElementById('financeiro-tabela');
        tbody.innerHTML = '';

        let totalReceitas = 0;
        let totalDespesas = 0;

        const transacoesOrdenadas = [...db.financeiro].sort((a,b) => new Date(b.data) - new Date(a.data));

        if (transacoesOrdenadas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Nenhuma transação registrada.</td></tr>`;
        } else {
            transacoesOrdenadas.forEach(t => {
                const isReceita = t.tipo === 'receita';
                if (isReceita) {
                    totalReceitas += t.valor;
                } else {
                    totalDespesas += t.valor;
                }

                const row = `
                    <tr>
                        <td>${new Date(t.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <td>${t.descricao} ${t.recurringId ? '<i class="fas fa-sync-alt fa-xs text-muted ms-1"></i>' : ''}</td>
                        <td><span class="badge bg-secondary">${t.categoria || 'N/A'}</span></td>
                        <td><span class="badge ${isReceita ? 'bg-success' : 'bg-danger'}">${isReceita ? 'Receita' : 'Despesa'}</span></td>
                        <td class="text-end fw-bold ${isReceita ? 'text-success' : 'text-danger'}">${t.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>
                           <button class="btn btn-sm btn-outline-primary edit-financeiro" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                           <button class="btn btn-sm btn-outline-danger delete-financeiro" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        const saldo = totalReceitas - totalDespesas;
        document.getElementById('financeiro-total-receitas').textContent = totalReceitas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('financeiro-total-despesas').textContent = totalDespesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const saldoEl = document.getElementById('financeiro-saldo-atual');
        saldoEl.textContent = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        saldoEl.className = saldo >= 0 ? 'text-success' : 'text-danger';
    }


    function renderRelatorios() {
        const relatorioDesempenho = document.getElementById('relatorio-desempenho');
        relatorioDesempenho.innerHTML = '';
        db.disciplinas.forEach(d => {
            const notas = [...db.trabalhos.filter(t => t.disciplinaId === d.id && t.nota !== null).map(t => parseFloat(t.nota)), ...db.provas.filter(p => p.disciplinaId === d.id && p.nota !== null).map(p => parseFloat(p.nota))];
            const media = notas.length > 0 ? (notas.reduce((a,b) => a+b, 0) / notas.length).toFixed(1) : "N/A";
            const badgeClass = media === "N/A" ? 'bg-secondary' : media >= 7 ? 'bg-success' : media >= 5 ? 'bg-warning text-dark' : 'bg-danger';
            relatorioDesempenho.innerHTML += `<div class="report-item"><span>${d.nome}</span><span class="badge ${badgeClass}">${media}</span></div>`;
        });
        
        const relatorioFrequencia = document.getElementById('relatorio-frequencia');
        relatorioFrequencia.innerHTML = '';
        db.disciplinas.forEach(d => relatorioFrequencia.innerHTML += `<div class="report-item"><span>${d.nome}</span><span class="badge ${d.frequencia >= 75 ? 'bg-success' : 'bg-warning text-dark'}">${d.frequencia}%</span></div>`);
        
        const relatorioTrabalhos = document.getElementById('relatorio-trabalhos');
        relatorioTrabalhos.innerHTML = '';
        db.disciplinas.forEach(d => relatorioTrabalhos.innerHTML += `<div class="report-item"><span>${d.nome}</span><span class="badge bg-info">${db.trabalhos.filter(t => t.disciplinaId === d.id && t.status === 'Entregue').length}/${db.trabalhos.filter(t => t.disciplinaId === d.id).length}</span></div>`);
        
        const relatorioProvas = document.getElementById('relatorio-provas');
        relatorioProvas.innerHTML = '';
        const provasRealizadas = db.provas.filter(p => p.status === 'Realizada');
        if (provasRealizadas.length === 0) {
            relatorioProvas.innerHTML = `<div class="empty-state"><p>Nenhuma prova realizada.</p></div>`;
        } else {
            provasRealizadas.forEach(p => {
                 const disciplina = getDisciplinaById(p.disciplinaId);
                 const nota = p.nota !== null ? p.nota.toFixed(1) : "N/A";
                 const badgeClass = nota === "N/A" ? 'bg-secondary' : nota >= 7 ? 'bg-success' : nota >= 5 ? 'bg-warning text-dark' : 'bg-danger';
                 relatorioProvas.innerHTML += `<div class="report-item"><span>${disciplina.nome} - ${p.conteudo}</span><span class="badge ${badgeClass}">${nota}</span></div>`;
            });
        }
    }

    function getEventsForDate(dateStr) {
        return [
            ...db.trabalhos.filter(t => t.entrega === dateStr).map(t => ({...t, type: 'assignment', date: t.entrega, title: t.titulo})),
            ...db.provas.filter(p => p.data === dateStr).map(p => ({...p, type: 'exam', date: p.data, title: p.conteudo})),
            ...db.eventos.filter(e => e.date === dateStr)
        ].sort((a,b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
    }
    
    //-----------------------------------------------------
    // 4. MANIPULAÇÃO DE EVENTOS E MODAIS
    //-----------------------------------------------------
    
    // Navegação
    document.body.addEventListener('click', function(e) {
        const navOrCardLink = e.target.closest('.nav-link, .card-link');
        if (navOrCardLink) {
            e.preventDefault();
            const targetId = navOrCardLink.dataset.target;
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(nl => nl.classList.remove('active'));
            document.querySelector(`.nav-link[data-target="${targetId}"]`).classList.add('active');
            
            const sidebar = document.getElementById('sidebar');
            if(sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        }
    });


    document.getElementById('sidebarToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));

    function populateDisciplinaSelects() {
        const selects = document.querySelectorAll('#trabalhoDisciplina, #provaDisciplina, #horarioDisciplina');
        const options = db.disciplinas.map(d => `<option value="${d.id}">${d.nome}</option>`).join('');
        selects.forEach(select => { 
            if (select) {
                const currentVal = select.value;
                select.innerHTML = options; 
                select.value = currentVal;
            }
        });
    }

    // Gerenciamento de Horários
    document.getElementById('saveHorario').addEventListener('click', () => {
        const id = document.getElementById('horarioId').value;
        const aula = {
            disciplinaId: parseInt(document.getElementById('horarioDisciplina').value),
            diaSemana: document.getElementById('horarioDiaSemana').value,
            inicio: document.getElementById('horarioInicio').value,
            fim: document.getElementById('horarioFim').value,
            local: document.getElementById('horarioLocal').value
        };

        if (!aula.disciplinaId || !aula.inicio || !aula.fim) { alert('Preencha os campos obrigatórios.'); return; }

        if (id) {
            const index = db.horarios.findIndex(h => h.id == id);
            db.horarios[index] = { ...db.horarios[index], ...aula };
        } else {
            aula.id = getNewId('horarios');
            db.horarios.push(aula);
        }
        
        saveDB();
        renderAll();
        bootstrap.Modal.getInstance(document.getElementById('horarioModal')).hide();
    });

    document.getElementById('deleteHorario').addEventListener('click', function() {
        const id = document.getElementById('horarioId').value;
        if(confirm('Tem certeza que deseja excluir esta aula?')) {
            db.horarios = db.horarios.filter(h => h.id != id);
            saveDB();
            renderAll();
            bootstrap.Modal.getInstance(document.getElementById('horarioModal')).hide();
        }
    });

    // Gerenciamento de Disciplinas, Trabalhos, Provas
    document.getElementById('saveDisciplina').addEventListener('click', () => {
        const id = document.getElementById('disciplinaId').value;
        const disciplina = {
            nome: document.getElementById('disciplinaNome').value,
            professor: document.getElementById('disciplinaProfessor').value,
            frequencia: parseInt(document.getElementById('disciplinaFrequencia').value)
        };
        if (!disciplina.nome) { alert('O nome da disciplina é obrigatório.'); return; }
        if (id) {
            const index = db.disciplinas.findIndex(d => d.id == id);
            db.disciplinas[index] = { ...db.disciplinas[index], ...disciplina };
        } else {
            disciplina.id = getNewId('disciplinas');
            db.disciplinas.push(disciplina);
        }
        saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('disciplinaModal')).hide();
    });
    
    document.getElementById('saveTrabalho').addEventListener('click', () => {
        const id = document.getElementById('trabalhoId').value;
        const trabalho = {
            disciplinaId: parseInt(document.getElementById('trabalhoDisciplina').value),
            titulo: document.getElementById('trabalhoTitulo').value,
            entrega: document.getElementById('trabalhoEntrega').value,
            status: document.getElementById('trabalhoStatus').value,
            prioridade: document.getElementById('trabalhoPrioridade').value,
            nota: document.getElementById('trabalhoNota').value === '' ? null : parseFloat(document.getElementById('trabalhoNota').value)
        };
        if (!trabalho.disciplinaId || !trabalho.titulo || !trabalho.entrega) { alert('Preencha os campos obrigatórios.'); return; }
        if (id) {
            const index = db.trabalhos.findIndex(t => t.id == id);
            db.trabalhos[index] = { ...db.trabalhos[index], ...trabalho };
        } else {
            trabalho.id = getNewId('trabalhos');
            db.trabalhos.push(trabalho);
        }
        saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('trabalhoModal')).hide();
    });
    
    document.getElementById('saveProva').addEventListener('click', () => {
        const id = document.getElementById('provaId').value;
        const prova = {
            disciplinaId: parseInt(document.getElementById('provaDisciplina').value),
            conteudo: document.getElementById('provaConteudo').value,
            data: document.getElementById('provaData').value,
            hora: document.getElementById('provaHora').value,
            status: document.getElementById('provaStatus').value,
            nota: document.getElementById('provaNota').value === '' ? null : parseFloat(document.getElementById('provaNota').value)
        };
        if (!prova.disciplinaId || !prova.conteudo || !prova.data) { alert('Preencha os campos obrigatórios.'); return; }
        if (id) {
            const index = db.provas.findIndex(p => p.id == id);
            db.provas[index] = { ...db.provas[index], ...prova };
        } else {
            prova.id = getNewId('provas');
            db.provas.push(prova);
        }
        saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('provaModal')).hide();
    });
    
    // Gerenciamento de Finanças (com recorrência)
    document.getElementById('financeiroRecurrence').addEventListener('change', function() {
        document.getElementById('financeiroRecurrenceEndDateWrapper').classList.toggle('d-none', this.value === 'none');
    });

    document.getElementById('saveFinanceiro').addEventListener('click', () => {
        const id = document.getElementById('financeiroId').value;
        const transacaoOriginal = id ? db.financeiro.find(t => t.id == id) : null;
        const recurringId = transacaoOriginal ? transacaoOriginal.recurringId : null;

        const handleSave = (scope) => {
            const baseTransacao = {
                tipo: document.getElementById('financeiroTipo').value,
                descricao: document.getElementById('financeiroDescricao').value,
                valor: parseFloat(document.getElementById('financeiroValor').value),
                categoria: document.getElementById('financeiroCategoria').value,
                data: document.getElementById('financeiroData').value
            };
            const recurrence = document.getElementById('financeiroRecurrence').value;
            const recurrenceEndDate = document.getElementById('financeiroRecurrenceEndDate').value;

            if (!baseTransacao.tipo || !baseTransacao.descricao || isNaN(baseTransacao.valor) || !baseTransacao.data) { alert('Preencha todos os campos obrigatórios.'); return; }
            if (recurrence !== 'none' && !recurrenceEndDate) { alert('Por favor, defina uma data final para a recorrência.'); return; }
            if (recurrenceEndDate && new Date(recurrenceEndDate) < new Date(baseTransacao.data)) { alert('A data final da recorrência não pode ser anterior à data de início.'); return; }
            
            if (id && recurringId && scope === 'all') {
                db.financeiro = db.financeiro.filter(t => t.recurringId !== recurringId);
            } else if (id && scope === 'this') {
                const index = db.financeiro.findIndex(t => t.id == id);
                db.financeiro[index] = { ...db.financeiro[index], ...baseTransacao, recurringId: null };
                saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('financeiroModal')).hide();
                return;
            }

            if (recurrence === 'none') {
                if(id && !recurringId) {
                    const index = db.financeiro.findIndex(t => t.id == id);
                    db.financeiro[index] = { ...db.financeiro[index], ...baseTransacao };
                } else {
                    baseTransacao.id = getNewId('financeiro');
                    db.financeiro.push(baseTransacao);
                }
            } else {
                const newRecurringId = recurringId && scope === 'all' ? recurringId : Date.now().toString();
                let currentDate = new Date(baseTransacao.data + "T00:00:00");
                const endDate = new Date(recurrenceEndDate + "T00:00:00");
                
                while(currentDate <= endDate) {
                    const newTransacao = { ...baseTransacao };
                    newTransacao.id = getNewId('financeiro');
                    newTransacao.recurringId = newRecurringId;
                    newTransacao.data = currentDate.toISOString().slice(0,10);
                    db.financeiro.push(newTransacao);

                    if (recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }
            saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('financeiroModal')).hide();
        };
        
        if(id && recurringId){
            const confirmationModal = new bootstrap.Modal(document.getElementById('recurringActionModal'));
            document.getElementById('recurringActionModalTitle').textContent = 'Ação em Transação Recorrente';
            document.getElementById('actionThisEvent').onclick = () => { handleSave('this'); confirmationModal.hide(); };
            document.getElementById('actionAllEvents').onclick = () => { handleSave('all'); confirmationModal.hide(); };
            confirmationModal.show();
        } else {
            handleSave('all');
        }
    });

    document.getElementById('deleteFinanceiro').addEventListener('click', function() {
        const id = document.getElementById('financeiroId').value;
        const transacao = db.financeiro.find(t => t.id == id);
        const recurringId = transacao ? transacao.recurringId : null;
        const financeiroModal = bootstrap.Modal.getInstance(document.getElementById('financeiroModal'));

        const handleDelete = (scope) => {
             if(scope === 'this') {
                db.financeiro = db.financeiro.filter(t => t.id != id);
            } else if (scope === 'all') {
                db.financeiro = db.financeiro.filter(t => t.recurringId !== recurringId);
            }
            saveDB(); renderAll(); financeiroModal.hide();
        }

        if(recurringId) {
            const confirmationModal = new bootstrap.Modal(document.getElementById('recurringActionModal'));
            document.getElementById('recurringActionModalTitle').textContent = 'Excluir Transação Recorrente';
            document.getElementById('actionThisEvent').onclick = () => { handleDelete('this'); confirmationModal.hide(); };
            document.getElementById('actionAllEvents').onclick = () => { handleDelete('all'); confirmationModal.hide(); };
            confirmationModal.show();
        } else {
            if(confirm('Tem certeza que deseja excluir esta transação?')) {
                db.financeiro = db.financeiro.filter(t => t.id != id);
                saveDB(); renderAll(); financeiroModal.hide();
            }
        }
    });

    // Modal Financeiro - Setup
    const financeiroModal = document.getElementById('financeiroModal');
    financeiroModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        if (!button.matches('.edit-financeiro')) { // Apenas para novos eventos
            const type = button.dataset.type;
            document.getElementById('financeiroTipo').value = type;
            document.getElementById('financeiroData').value = new Date().toISOString().slice(0, 10);
        }
    });

    // Gerenciamento de Eventos da Agenda (com recorrência)
    document.getElementById('eventRecurrence').addEventListener('change', function() {
        document.getElementById('eventRecurrenceEndDateWrapper').classList.toggle('d-none', this.value === 'none');
    });

    document.getElementById('saveEvent').addEventListener('click', () => {
        const id = document.getElementById('eventId').value;
        const recurringId = document.getElementById('eventRecurringId').value;

        const handleSave = (scope) => {
            const baseEvent = {
                title: document.getElementById('eventTitle').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                description: document.getElementById('eventDescription').value,
            };
            const recurrence = document.getElementById('eventRecurrence').value;
            const recurrenceEndDate = document.getElementById('eventRecurrenceEndDate').value;

            if (!baseEvent.title || !baseEvent.type || !baseEvent.date) { alert('Preencha os campos obrigatórios.'); return; }
            if (recurrence !== 'none' && !recurrenceEndDate) { alert('Por favor, defina uma data final para a recorrência.'); return; }
            if (recurrenceEndDate && new Date(recurrenceEndDate) < new Date(baseEvent.date)) { alert('A data final da recorrência não pode ser anterior à data de início.'); return; }

            if (id && recurringId && scope === 'all') { // Editando toda a série
                db.eventos = db.eventos.filter(e => e.recurringId !== recurringId);
            } else if (id && scope === 'this') { // Editando apenas este
                const index = db.eventos.findIndex(e => e.id == id);
                db.eventos[index] = { ...db.eventos[index], ...baseEvent, recurringId: null };
                saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                return;
            }

            if (recurrence === 'none') {
                if(id && !recurringId) { // Editando um evento único (que já era único)
                    const index = db.eventos.findIndex(e => e.id == id);
                    db.eventos[index] = { ...db.eventos[index], ...baseEvent };
                } else { // Criando um novo evento único (ou salvando um recorrente como único)
                    baseEvent.id = getNewId('eventos');
                    db.eventos.push(baseEvent);
                }
            } else {
                const newRecurringId = recurringId && scope === 'all' ? recurringId : Date.now().toString();
                let currentDate = new Date(baseEvent.date + "T00:00:00");
                const endDate = new Date(recurrenceEndDate + "T00:00:00");
                
                while(currentDate <= endDate) {
                    const newEvent = { ...baseEvent };
                    newEvent.id = getNewId('eventos');
                    newEvent.recurringId = newRecurringId;
                    newEvent.date = currentDate.toISOString().slice(0,10);
                    db.eventos.push(newEvent);

                    if (recurrence === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                    else if (recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }

            saveDB(); renderAll(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
        };
        
        if(id && recurringId){
            const confirmationModal = new bootstrap.Modal(document.getElementById('recurringActionModal'));
            document.getElementById('recurringActionModalTitle').textContent = 'Ação em Evento Recorrente';
            document.getElementById('actionThisEvent').onclick = () => { handleSave('this'); confirmationModal.hide(); };
            document.getElementById('actionAllEvents').onclick = () => { handleSave('all'); confirmationModal.hide(); };
            confirmationModal.show();
        } else {
            handleSave('all');
        }
    });

    document.getElementById('deleteEvent').addEventListener('click', function() {
        const id = document.getElementById('eventId').value;
        const recurringId = document.getElementById('eventRecurringId').value;
        const eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));

        const handleDelete = (scope) => {
             if(scope === 'this') {
                db.eventos = db.eventos.filter(e => e.id != id);
            } else if (scope === 'all') {
                db.eventos = db.eventos.filter(e => e.recurringId !== recurringId);
            }
            saveDB(); renderAll(); eventModal.hide();
        }

        if(recurringId) {
            const confirmationModal = new bootstrap.Modal(document.getElementById('recurringActionModal'));
            document.getElementById('recurringActionModalTitle').textContent = 'Excluir Evento Recorrente';
            document.getElementById('actionThisEvent').onclick = () => { handleDelete('this'); confirmationModal.hide(); };
            document.getElementById('actionAllEvents').onclick = () => { handleDelete('all'); confirmationModal.hide(); };
            confirmationModal.show();
        } else {
            if(confirm('Tem certeza que deseja excluir este evento?')) {
                db.eventos = db.eventos.filter(e => e.id != id);
                saveDB(); renderAll(); eventModal.hide();
            }
        }
    });

    // Limpeza de modais
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', () => {
            modal.querySelector('form')?.reset();
            modal.querySelectorAll('input[type="hidden"]').forEach(i => i.value = '');
            if (modal.id === 'horarioModal') document.getElementById('deleteHorario').classList.add('d-none');
            if (modal.id === 'eventModal') {
                document.getElementById('deleteEvent').classList.add('d-none');
                document.getElementById('eventRecurrenceEndDateWrapper').classList.add('d-none');
                document.getElementById('eventRecurrence').disabled = false;
                document.getElementById('eventRecurrenceEndDate').disabled = false;
            }
            if (modal.id === 'financeiroModal') {
                document.getElementById('deleteFinanceiro').classList.add('d-none');
                document.getElementById('financeiroRecurrenceEndDateWrapper').classList.add('d-none');
                document.getElementById('financeiroRecurrence').disabled = false;
                document.getElementById('financeiroRecurrenceEndDate').disabled = false;
            }
        });
    });
    
    // Delegação de eventos para botões de editar/excluir
    document.body.addEventListener('click', function(e) {
        let id, element;
        const target = e.target.closest('button, a, .schedule-class-item, .event-item');
        if (!target) return;
        
        id = target.dataset.id;
        
        if (target.matches('.edit-disciplina, .delete-disciplina')) {
            e.preventDefault();
            element = db.disciplinas.find(d => d.id == id);
            if (target.matches('.edit-disciplina')) {
                document.getElementById('disciplinaId').value = element.id;
                document.getElementById('disciplinaNome').value = element.nome;
                document.getElementById('disciplinaProfessor').value = element.professor;
                document.getElementById('disciplinaFrequencia').value = element.frequencia;
                new bootstrap.Modal(document.getElementById('disciplinaModal')).show();
            } else {
                 if (confirm('Tem certeza que deseja excluir esta disciplina e todos os seus dados associados?')) {
                    db.disciplinas = db.disciplinas.filter(d => d.id != id);
                    db.trabalhos = db.trabalhos.filter(t => t.disciplinaId != id);
                    db.provas = db.provas.filter(p => p.disciplinaId != id);
                    db.horarios = db.horarios.filter(h => h.disciplinaId != id);
                    saveDB(); renderAll();
                }
            }
        } else if (target.matches('.edit-trabalho, .delete-trabalho')) {
            element = db.trabalhos.find(item => item.id == id);
            if (target.matches('.edit-trabalho')) {
                document.getElementById('trabalhoId').value = element.id;
                document.getElementById('trabalhoDisciplina').value = element.disciplinaId;
                document.getElementById('trabalhoTitulo').value = element.titulo;
                document.getElementById('trabalhoEntrega').value = element.entrega;
                document.getElementById('trabalhoStatus').value = element.status;
                document.getElementById('trabalhoPrioridade').value = element.prioridade;
                document.getElementById('trabalhoNota').value = element.nota;
                new bootstrap.Modal(document.getElementById('trabalhoModal')).show();
            } else if (confirm('Tem certeza?')) {
                db.trabalhos = db.trabalhos.filter(item => item.id != id);
                saveDB(); renderAll();
            }
        } else if (target.matches('.edit-prova, .delete-prova')) {
             element = db.provas.find(item => item.id == id);
             if (target.matches('.edit-prova')) {
                document.getElementById('provaId').value = element.id;
                document.getElementById('provaDisciplina').value = element.disciplinaId;
                document.getElementById('provaConteudo').value = element.conteudo;
                document.getElementById('provaData').value = element.data;
                document.getElementById('provaHora').value = element.hora;
                document.getElementById('provaStatus').value = element.status;
                document.getElementById('provaNota').value = element.nota;
                new bootstrap.Modal(document.getElementById('provaModal')).show();
            } else if (confirm('Tem certeza?')) {
                db.provas = db.provas.filter(item => item.id != id);
                saveDB(); renderAll();
            }
        } else if (target.matches('.edit-financeiro')) {
             element = db.financeiro.find(item => item.id == id);
             if (element) {
                document.getElementById('financeiroId').value = element.id;
                document.getElementById('financeiroTipo').value = element.tipo;
                document.getElementById('financeiroDescricao').value = element.descricao;
                document.getElementById('financeiroValor').value = element.valor;
                document.getElementById('financeiroCategoria').value = element.categoria;
                document.getElementById('financeiroData').value = element.data;
                document.getElementById('deleteFinanceiro').classList.remove('d-none');
                
                if (element.recurringId) {
                    document.getElementById('financeiroRecurrence').disabled = true;
                    document.getElementById('financeiroRecurrenceEndDate').disabled = true;
                }
                new bootstrap.Modal(document.getElementById('financeiroModal')).show();
             }
        } else if (target.matches('.delete-financeiro')) {
            const financeiroModal = new bootstrap.Modal(document.getElementById('financeiroModal'));
            const element = db.financeiro.find(t => t.id == id);
            const recurringId = element ? element.recurringId : null;

            const handleDelete = (scope) => {
                if(scope === 'this') {
                    db.financeiro = db.financeiro.filter(t => t.id != id);
                } else if (scope === 'all') {
                    db.financeiro = db.financeiro.filter(t => t.recurringId !== recurringId);
                }
                saveDB(); renderAll();
            }

            if(recurringId) {
                const confirmationModal = new bootstrap.Modal(document.getElementById('recurringActionModal'));
                document.getElementById('recurringActionModalTitle').textContent = 'Excluir Transação Recorrente';
                document.getElementById('actionThisEvent').onclick = () => { handleDelete('this'); confirmationModal.hide(); };
                document.getElementById('actionAllEvents').onclick = () => { handleDelete('all'); confirmationModal.hide(); };
                confirmationModal.show();
            } else {
                if(confirm('Tem certeza que deseja excluir esta transação?')) {
                   handleDelete('this');
                }
            }
        } else if (target.matches('.schedule-class-item')) {
            element = db.horarios.find(h => h.id == id);
            document.getElementById('horarioId').value = element.id;
            document.getElementById('horarioDisciplina').value = element.disciplinaId;
            document.getElementById('horarioDiaSemana').value = element.diaSemana;
            document.getElementById('horarioInicio').value = element.inicio;
            document.getElementById('horarioFim').value = element.fim;
            document.getElementById('horarioLocal').value = element.local;
            document.getElementById('deleteHorario').classList.remove('d-none');
            new bootstrap.Modal(document.getElementById('horarioModal')).show();
        }
    });

    document.getElementById('prev-month').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderAgenda(); });
    document.getElementById('next-month').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderAgenda(); });
    
    document.getElementById('calendar-days').addEventListener('click', (e) => {
        if (e.target.classList.contains('calendar-day') && !e.target.classList.contains('empty')) {
            const date = e.target.dataset.date;
            const container = document.getElementById('agenda-eventos-dia');
            const events = getEventsForDate(date);
            document.querySelectorAll('.calendar-day.current').forEach(d => d.classList.remove('current'));
            e.target.classList.add('current');
            container.innerHTML = `<h4 class="card-title mb-4">Eventos de ${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR')}</h4>`;
            if (events.length === 0) {
                container.innerHTML += `<p class="text-muted text-center">Nenhum evento agendado</p>`;
            } else {
                events.forEach(evento => {
                    const item = document.createElement('div');
                    item.className = `event-item ${evento.type}`;
                    item.innerHTML = `<h6 class="mb-0">${evento.title}</h6><p class="mb-0 small">${evento.time || ''}</p>`;
                    item.onclick = () => {
                         const eventData = db.eventos.find(e => e.id === evento.id);
                         if (eventData) {
                             document.getElementById('eventId').value = eventData.id;
                             document.getElementById('eventRecurringId').value = eventData.recurringId || '';
                             document.getElementById('eventTitle').value = eventData.title;
                             document.getElementById('eventType').value = eventData.type;
                             document.getElementById('eventDate').value = eventData.date;
                             document.getElementById('eventTime').value = eventData.time;
                             document.getElementById('eventDescription').value = eventData.description;

                             document.getElementById('deleteEvent').classList.remove('d-none');
                             if(eventData.recurringId){
                                document.getElementById('eventRecurrence').disabled = true;
                                document.getElementById('eventRecurrenceEndDate').disabled = true;
                             }

                             new bootstrap.Modal(document.getElementById('eventModal')).show();
                         }
                    };
                    container.appendChild(item);
                });
            }
        }
    });
    
    //-----------------------------------------------------
    // 5. BACKUP E RESTAURAÇÃO
    //-----------------------------------------------------

    document.getElementById('backup-btn').addEventListener('click', () => {
        const dataStr = JSON.stringify(db, null, 2);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([dataStr], { type: 'application/json' }));
        link.download = `lex_academica_backup_${new Date().toISOString().slice(0, 10)}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
        alert('Backup criado com sucesso!');
    });

    document.getElementById('restore-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file || !confirm('Restaurar este backup substituirá todos os dados atuais. Continuar?')) { event.target.value = ''; return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const restoredDb = JSON.parse(e.target.result);
                if (restoredDb.disciplinas && restoredDb.trabalhos && restoredDb.provas) {
                    db = restoredDb;
                    saveDB();
                    alert('Backup restaurado! A página será recarregada.');
                    location.reload();
                } else { alert('Arquivo de backup inválido.'); }
            } catch (error) { alert('Erro ao ler o arquivo de backup.'); } 
            finally { event.target.value = ''; }
        };
        reader.readAsText(file);
    });

    // Inicialização da aplicação
    init();
});
</script>
</body>
</html>
